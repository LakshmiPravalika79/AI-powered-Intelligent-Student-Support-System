<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechEDU - AI Student Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #0D1018;
            --bg-muted: #131722;
            --bg-elevated: #191F2C;
            --bg-highlight: #20283A;
            --bg-soft: #262F45;
            --text-primary: #F2F4FF;
            --text-secondary: #A3ADC9;
            --text-tertiary: #7E88A6;
            --accent-primary: #8D9CFF;
            --accent-primary-strong: #6E7AFD;
            --accent-soft: rgba(141, 156, 255, 0.18);
            --border-soft: rgba(255, 255, 255, 0.06);
            --border-strong: rgba(141, 156, 255, 0.4);
            --radius-md: 14px;
            --radius-lg: 20px;
            --shadow-soft: 0 30px 60px rgba(4, 6, 12, 0.45);
            --shadow-hover: 0 40px 70px rgba(8, 12, 22, 0.55);
            --transition-base: cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background:
                radial-gradient(120% 120% at 10% -20%, rgba(110, 122, 253, 0.32), transparent 55%),
                radial-gradient(120% 140% at 90% 0%, rgba(20, 26, 45, 0.65), transparent 60%),
                var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
            letter-spacing: 0.01em;
            -webkit-font-smoothing: antialiased;
        }

        a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--accent-primary-strong);
        }

        button {
            font-family: inherit;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.015em;
            margin: 0;
            color: var(--text-primary);
        }

        h1 { font-size: clamp(1.8rem, 2vw + 1rem, 2.4rem); }
        h2 { font-size: clamp(1.6rem, 1.4vw + 1rem, 2rem); }
        h3 { font-size: clamp(1.3rem, 1vw + 0.9rem, 1.6rem); }

        p, span, label, input, select {
            color: var(--text-secondary);
        }

        .card {
            background: linear-gradient(160deg, rgba(33, 40, 58, 0.92), rgba(18, 23, 35, 0.92));
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            transition: transform 0.45s var(--transition-base), box-shadow 0.45s var(--transition-base), border 0.45s ease;
        }

        .card:hover {
            transform: translateY(-6px);
            border-color: var(--border-strong);
            box-shadow: var(--shadow-hover);
        }

        .surface-muted {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.75rem 1.6rem;
            font-weight: 500;
            font-size: 0.95rem;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all 0.4s var(--transition-base);
            position: relative;
            overflow: hidden;
            color: rgba(255, 255, 255, 0.95);
        }

        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.18), transparent 60%);
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary-strong), var(--accent-primary));
            box-shadow: 0 18px 35px rgba(110, 122, 253, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 45px rgba(110, 122, 253, 0.35);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-icon {
            width: 2.75rem;
            height: 2.75rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 999px;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .input-field {
            width: 100%;
            background: rgba(22, 28, 43, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: 0.85rem 1.2rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.35s var(--transition-base);
        }

        .input-field:focus {
            border-color: var(--border-strong);
            box-shadow: 0 0 0 3px rgba(141, 156, 255, 0.12);
            background: rgba(29, 34, 51, 0.9);
            outline: none;
        }

        .input-field::placeholder {
            color: rgba(163, 173, 201, 0.5);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.55rem 0.95rem;
            font-size: 0.88rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.35s var(--transition-base);
        }

        .chip:hover {
            transform: translateY(-2px);
            color: var(--text-primary);
            border-color: var(--border-strong);
            background: rgba(141, 156, 255, 0.12);
        }

        .chip-accent {
            color: rgba(215, 224, 255, 0.85);
            background: rgba(141, 156, 255, 0.16);
            border-color: rgba(141, 156, 255, 0.22);
        }

        .chip-success {
            color: #AEE8C9;
            background: rgba(118, 217, 166, 0.16);
            border-color: rgba(118, 217, 166, 0.25);
        }

        .chip-purple {
            color: #D2B8FF;
            background: rgba(176, 118, 235, 0.18);
            border-color: rgba(176, 118, 235, 0.22);
        }

        .chip-warning {
            color: #FFDCA6;
            background: rgba(246, 199, 125, 0.16);
            border-color: rgba(246, 199, 125, 0.22);
        }

        .chip-danger {
            color: #FFB5B0;
            background: rgba(242, 141, 133, 0.18);
            border-color: rgba(242, 141, 133, 0.24);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.04em;
            background: rgba(141, 156, 255, 0.18);
            color: var(--accent-primary);
            border: 1px solid rgba(141, 156, 255, 0.25);
        }

        .layout-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .app-header {
            background: linear-gradient(135deg, rgba(28, 34, 52, 0.95), rgba(16, 20, 33, 0.88));
            border: 1px solid rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(26px);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.75rem;
            margin: 1.5rem auto 1rem;
            box-shadow: 0 30px 60px rgba(4, 6, 12, 0.45);
        }

        .tab-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.65rem 1.2rem;
            border-radius: 999px;
            color: var(--text-secondary);
            transition: all 0.35s var(--transition-base);
            background: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.tab-active {
            background: rgba(141, 156, 255, 0.16);
            color: var(--accent-primary);
            box-shadow: 0 12px 20px rgba(141, 156, 255, 0.18);
        }

        .logout-label {
            display: none;
        }

        .message-bubble {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.55;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 14px 24px rgba(5, 7, 14, 0.35);
        }

        .message-bubble.user {
            margin-left: auto;
            background: linear-gradient(135deg, var(--accent-primary-strong), var(--accent-primary));
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        .message-bubble.bot {
            margin-right: auto;
            background: rgba(30, 37, 53, 0.95);
            border-bottom-left-radius: 6px;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 12px 20px rgba(5, 8, 16, 0.35);
        }

        .message-avatar.user {
            background: linear-gradient(135deg, rgba(142, 157, 255, 0.38), rgba(71, 87, 214, 0.85));
            color: rgba(255, 255, 255, 0.95);
        }

        .message-avatar.bot {
            background: rgba(36, 43, 63, 0.85);
            color: var(--accent-primary);
        }

        .chat-container {
            height: calc(100vh - 280px);
            padding: 1.5rem;
            background: rgba(12, 16, 26, 0.55);
        }

        .quick-actions {
            background: rgba(16, 21, 34, 0.72);
            border-top: 1px solid rgba(255, 255, 255, 0.04);
            padding: 1.1rem 1.5rem;
        }

        .quick-actions .label {
            font-size: 0.85rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(163, 173, 201, 0.6);
        }

        .input-shell {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.04);
            background: rgba(12, 16, 26, 0.55);
        }

        .typing-indicator span {
            opacity: 0.4;
            animation: typing 1.4s infinite ease-in-out;
            display: inline-block;
        }

        .stats-grid {
            display: grid;
            gap: 1.2rem;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            inset: -20%;
            background: radial-gradient(circle at top right, rgba(141, 156, 255, 0.22), transparent 55%);
            opacity: 0.8;
        }

        .stat-card > * {
            position: relative;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(141, 156, 255, 0.16);
            color: var(--accent-primary);
        }

        .section-subtle {
            background: rgba(14, 17, 27, 0.72);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .login-backdrop {
            background:
                radial-gradient(90% 120% at 15% -20%, rgba(110, 122, 253, 0.45), transparent 55%),
                radial-gradient(80% 120% at 85% -20%, rgba(43, 50, 85, 0.6), transparent 65%),
                var(--bg-base);
        }

        .login-card {
            padding: 3rem 3.25rem;
        }

        .login-badge {
            margin-top: 0.75rem;
        }

        .login-icon {
            width: 5rem;
            height: 5rem;
            border-radius: 20px;
            margin: 0 auto 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(141, 156, 255, 0.35), rgba(141, 156, 255, 0.05));
            border: 1px solid rgba(141, 156, 255, 0.25);
            box-shadow: 0 18px 35px rgba(16, 20, 35, 0.4);
        }

        .login-meta {
            margin-top: 2rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: var(--radius-md);
            padding: 1.4rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .login-meta p {
            margin: 0.35rem 0;
            color: rgba(215, 224, 255, 0.82);
            font-size: 0.9rem;
        }

        .login-meta strong {
            color: var(--text-primary);
        }

        .error-banner {
            display: none;
            margin-top: 1.5rem;
            padding: 0.95rem 1.1rem;
            border-radius: var(--radius-md);
            background: rgba(242, 141, 133, 0.08);
            border: 1px solid rgba(242, 141, 133, 0.22);
            color: #F2B7B2;
            font-size: 0.9rem;
        }

        .error-banner.active {
            display: flex;
            gap: 0.6rem;
            align-items: flex-start;
        }

        .scroll-area {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        .scroll-area::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
        }

        .scroll-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 999px;
        }

        .scroll-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .shadow-lg,
        .shadow-2xl {
            box-shadow: var(--shadow-soft) !important;
        }

        #mainApp .bg-white,
        #mainApp .bg-gray-50,
        #mainApp .bg-gray-100 {
            background: linear-gradient(160deg, rgba(33, 40, 58, 0.92), rgba(18, 23, 35, 0.92)) !important;
            border: 1px solid var(--border-soft);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        #mainApp .border {
            border-color: rgba(255, 255, 255, 0.06) !important;
        }

        #mainApp .border-t {
            border-color: rgba(255, 255, 255, 0.04) !important;
        }

        #mainApp .text-gray-800,
        #mainApp .text-gray-700 {
            color: var(--text-primary) !important;
        }

        #mainApp .text-gray-600,
        #mainApp .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        #mainApp .text-gray-400 {
            color: var(--text-tertiary) !important;
        }

        #mainApp .text-blue-600,
        #mainApp .text-blue-700,
        #mainApp .text-blue-800 {
            color: var(--accent-primary) !important;
        }

        .bg-blue-600 {
            background: linear-gradient(135deg, var(--accent-primary-strong), var(--accent-primary)) !important;
        }

        [class~="hover:bg-blue-700"]:hover {
            background: linear-gradient(135deg, var(--accent-primary-strong), var(--accent-primary)) !important;
            box-shadow: 0 18px 35px rgba(110, 122, 253, 0.3);
        }

        .bg-blue-100 {
            background: rgba(141, 156, 255, 0.16) !important;
            color: var(--accent-primary) !important;
        }

        .bg-green-100 {
            background: rgba(118, 217, 166, 0.16) !important;
            color: #AEE8C9 !important;
        }

        .bg-purple-100 {
            background: rgba(176, 118, 235, 0.18) !important;
            color: #D2B8FF !important;
        }

        .bg-orange-100 {
            background: rgba(246, 199, 125, 0.18) !important;
            color: #FFDCAA !important;
        }

        .bg-red-100 {
            background: rgba(242, 141, 133, 0.18) !important;
            color: #F7B7B0 !important;
        }

        .text-green-600 {
            color: #9CE6C0 !important;
        }

        .text-purple-600 {
            color: #C8B6FF !important;
        }

        .text-orange-600 {
            color: #FFC893 !important;
        }

        .text-red-600 {
            color: #F6A6A0 !important;
        }

        .border-gray-300,
        .border-gray-200 {
            border-color: rgba(255, 255, 255, 0.08) !important;
        }

        .bg-blue-50,
        .from-blue-50 {
            background: rgba(141, 156, 255, 0.08) !important;
        }

        .bg-purple-50,
        .from-purple-600 {
            background: linear-gradient(135deg, rgba(123, 90, 255, 0.45), rgba(35, 30, 65, 0.9)) !important;
        }

        .from-blue-600,
        .to-blue-700 {
            background: linear-gradient(135deg, rgba(110, 122, 253, 0.4), rgba(38, 45, 84, 0.85)) !important;
        }

        .from-green-600,
        .to-teal-600 {
            background: linear-gradient(135deg, rgba(79, 196, 190, 0.25), rgba(32, 74, 86, 0.65)) !important;
        }

        .to-purple-700 {
            background: linear-gradient(135deg, rgba(111, 76, 255, 0.35), rgba(45, 32, 85, 0.75)) !important;
        }

        .text-primary {
            color: var(--text-primary) !important;
        }

        .text-secondary {
            color: var(--text-secondary) !important;
        }

        .text-tertiary {
            color: var(--text-tertiary) !important;
        }

        .soft-enter {
            opacity: 0;
            animation: slideIn 0.6s var(--transition-base) forwards;
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
                margin-top: 1rem;
            }

            .card {
                border-radius: 16px;
            }

            .login-card {
                padding: 2.5rem 2rem;
            }

            .tab-btn {
                padding: 0.55rem 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen text-primary">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen login-backdrop flex items-center justify-center px-4 py-12">
        <div class="card login-card w-full max-w-lg soft-enter">
            <div class="text-center">
                <div class="login-icon">
                    <i class="fas fa-graduation-cap text-2xl text-primary"></i>
                </div>
                <div class="badge text-xs tracking-widest uppercase">AI-Powered Access</div>
                <h1 class="mt-4">TechEDU Student Support</h1>
                <p class="mt-2 text-secondary">A quietly confident companion for every learning journey.</p>
            </div>

            <form id="loginForm" class="mt-10 space-y-5">
                <div>
                    <label class="block text-sm text-secondary font-medium mb-2">Email</label>
                    <input type="email" id="email" value="sarah.johnson@techedu.edu" autocomplete="email"
                        class="input-field" placeholder="name@techedu.edu">
                </div>
                <div>
                    <label class="block text-sm text-secondary font-medium mb-2">Password</label>
                    <input type="password" id="password" value="demo123" autocomplete="current-password"
                        class="input-field" placeholder="Enter your password">
                </div>
                <button type="submit" class="btn btn-primary w-full justify-center">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </button>
            </form>

            <div class="login-meta">
                <p class="text-tertiary text-xs uppercase tracking-[0.2em]">Demo Credentials</p>
                <p>ğŸ‘¨â€ğŸ“ <strong>Student:</strong> sarah.johnson@techedu.edu / demo123</p>
                <p>ğŸ‘” <strong>Staff:</strong> advisor.smith@techedu.edu / staff123</p>
                <p>ğŸ‘‘ <strong>Admin:</strong> admin@techedu.edu / admin123</p>
            </div>

            <div id="loginError" class="error-banner">
                <i class="fas fa-exclamation-triangle mt-0.5"></i>
                <span></span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="app-header layout-container soft-enter">
            <div class="flex flex-wrap items-center justify-between gap-5">
                <div class="flex items-center gap-4">
                    <div class="btn-icon text-primary bg-accent-soft">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold">TechEDU Student Support</h2>
                        <p class="text-tertiary text-sm mt-1">Always-on assistance for students, advisors, and admins.</p>
                    </div>
                </div>

                <nav class="flex items-center gap-2 flex-wrap">
                    <button onclick="showTab('chat')" id="chatTab" class="tab-btn tab-active">
                        <i class="fas fa-comments"></i><span>Chat</span>
                    </button>
                    <button onclick="showTab('analytics')" id="analyticsTab" class="tab-btn">
                        <i class="fas fa-chart-line"></i><span>Analytics</span>
                    </button>
                    <button onclick="showTab('support')" id="supportTab" class="tab-btn hidden">
                        <i class="fas fa-headset"></i><span>Support</span>
                    </button>
                    <button onclick="showTab('admin')" id="adminTab" class="tab-btn hidden">
                        <i class="fas fa-shield-alt"></i><span>Admin</span>
                    </button>
                    <button onclick="showTab('profile')" id="profileTab" class="tab-btn">
                        <i class="fas fa-user"></i><span>Profile</span>
                    </button>
                </nav>

                <div class="flex items-center gap-3">
                    <div id="userBadge" class="chip chip-accent hidden">
                        <i class="fas fa-id-badge"></i>
                        <span id="userRole">Student</span>
                    </div>
                    <button onclick="logout()" class="btn-icon" title="Sign out">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat View -->
        <div id="chatView" class="layout-container max-w-5xl mx-auto px-4 pb-8">
            <div class="card overflow-hidden soft-enter">
                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-container scroll-area space-y-4">
                    <!-- Welcome message will be added by JS -->
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="flex flex-wrap gap-3 items-center justify-between">
                        <p class="label">Quick questions</p>
                        <button id="myTicketsBtn" onclick="showMyTickets()" class="chip chip-accent text-xs">
                            <i class="fas fa-ticket-alt"></i><span id="ticketsBtnText">ğŸ“‹ My Tickets</span>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button onclick="askQuestion('When is my next financial aid disbursement?')" class="chip">
                            ğŸ’° Financial Aid
                        </button>
                        <button onclick="askQuestion('What is my current GPA?')" class="chip chip-success">
                            ğŸ“Š My GPA
                        </button>
                        <button onclick="askQuestion('Where is my dorm room located?')" class="chip chip-purple">
                            ğŸ  Housing
                        </button>
                        <button onclick="askQuestion('How do I register for next semester?')" class="chip chip-warning">
                            ğŸ“š Registration
                        </button>
                        <button onclick="askQuestion('I have a complaint or issue')" class="chip chip-danger">
                            âš ï¸ Report Issue
                        </button>
                    </div>
                </div>
                
                <!-- Input -->
                <div class="input-shell">
                    <form id="chatForm" class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="messageInput" placeholder="Ask me anything about your student services..."
                            class="flex-1 input-field" autocomplete="off">
                        <button type="submit" class="btn btn-primary md:w-auto w-full justify-center">
                            <i class="fas fa-paper-plane"></i>
                            <span>Send</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" class="hidden layout-container max-w-6xl mx-auto px-4 pb-10">
            <div class="soft-enter mb-8">
                <h2 class="text-xl font-semibold text-primary">Welcome back, <span id="analyticsStudentName">Student</span></h2>
                <p class="text-secondary mt-2">Hereâ€™s your current status and a few hand-picked suggestions for staying ahead.</p>
            </div>

            <div class="insight-grid two soft-enter">
                <div class="card insight-card p-6">
                    <span class="metric-label">Academic Snapshot</span>
                    <div class="metric-value" id="analyticsGpa">--</div>
                    <p class="metric-subtext" id="analyticsProgram">Program â€”</p>
                    <div class="progress-pill" id="analyticsYear">Year --</div>
                    <div class="insight-grid two mt-6">
                        <div>
                            <p class="metric-label">Active Courses</p>
                            <p class="metric-subtext" id="analyticsCourseCount">--</p>
                        </div>
                        <div>
                            <p class="metric-label">Financial Aid</p>
                            <p class="metric-subtext" id="analyticsAidStatus">--</p>
                        </div>
                    </div>
                </div>

                <div class="card insight-card p-6">
                    <span class="metric-label">Support Activity</span>
                    <div class="metric-value" id="analyticsQuestions">--</div>
                    <p class="metric-subtext">Questions you've asked this term</p>
                    <div class="insight-grid two mt-6">
                        <div>
                            <p class="metric-label">Instant Answers</p>
                            <p class="metric-subtext" id="analyticsInstantRate">--</p>
                        </div>
                        <div>
                            <p class="metric-label">Avg Response Time</p>
                            <p class="metric-subtext" id="analyticsResponse">--</p>
                        </div>
                    </div>
                    <div class="progress-pill mt-6">
                        <i class="fas fa-smile"></i>
                        <span id="analyticsSatisfaction">Satisfaction --</span>
                    </div>
                </div>
            </div>

            <div class="insight-grid two soft-enter mt-8">
                <div class="card insight-card p-6">
                    <div class="flex items-center justify-between">
                        <span class="metric-label">Course Progress</span>
                        <div class="chip chip-accent text-xs"><i class="fas fa-book-reader"></i> In progress</div>
                    </div>
                    <ul class="course-list" id="analyticsCourseList"></ul>
                </div>

                <div class="card insight-card p-6">
                    <div class="flex items-center justify-between">
                        <span class="metric-label">Upcoming &amp; Reminders</span>
                        <div class="chip text-xs"><i class="fas fa-calendar"></i> Stay prepared</div>
                    </div>
                    <ul class="timeline" id="analyticsTimeline"></ul>
                </div>
            </div>

            <div class="insight-grid two soft-enter mt-8">
                <div class="card insight-card p-6">
                    <div class="flex items-center justify-between">
                        <span class="metric-label">Personalized Suggestions</span>
                        <div class="chip chip-success text-xs"><i class="fas fa-leaf"></i> Balance</div>
                    </div>
                    <ul class="tip-list" id="analyticsTips"></ul>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profileView" class="hidden max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-3xl"></i>
                        </div>
                        <div>
                            <h2 id="profileName" class="text-2xl font-bold">Loading...</h2>
                            <p id="profileProgram" class="text-blue-100">--</p>
                        </div>
                    </div>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg mb-3"><i class="fas fa-graduation-cap mr-2 text-blue-600"></i>Academic Info</h3>
                        <div class="space-y-2">
                            <p><span class="text-gray-500">Student ID:</span> <span id="profileId" class="font-medium">--</span></p>
                            <p><span class="text-gray-500">Year:</span> <span id="profileYear" class="font-medium">--</span></p>
                            <p><span class="text-gray-500">GPA:</span> <span id="profileGpa" class="font-medium">--</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-3"><i class="fas fa-home mr-2 text-green-600"></i>Housing</h3>
                        <div class="space-y-2">
                            <p><span class="text-gray-500">Building:</span> <span id="profileBuilding" class="font-medium">--</span></p>
                            <p><span class="text-gray-500">Room:</span> <span id="profileRoom" class="font-medium">--</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-3"><i class="fas fa-dollar-sign mr-2 text-purple-600"></i>Financial Aid</h3>
                        <div class="space-y-2">
                            <p><span class="text-gray-500">Status:</span> <span id="profileAidStatus" class="font-medium">--</span></p>
                            <p><span class="text-gray-500">Amount:</span> <span id="profileAidAmount" class="font-medium">--</span></p>
                            <p><span class="text-gray-500">Next Disbursement:</span> <span id="profileAidDate" class="font-medium">--</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-3"><i class="fas fa-book mr-2 text-orange-600"></i>Current Courses</h3>
                        <div id="profileCourses" class="space-y-2">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Staff Portal (Staff/Admin Only) -->
        <div id="supportView" class="hidden max-w-6xl mx-auto p-4">
            <!-- Support Header -->
            <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-2xl p-6 text-white mb-6 shadow-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-headset text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">Support Staff Portal</h2>
                            <p class="text-green-100">Manage escalated student queries</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-green-100">Escalation Threshold</p>
                        <p class="text-2xl font-bold">&lt; 70% Confidence</p>
                    </div>
                </div>
            </div>

            <!-- Escalation Stats -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-gray-500 text-sm">Open Tickets</p>
                    <p id="supportOpenCount" class="text-2xl font-bold text-red-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
                    <p class="text-gray-500 text-sm">In Progress</p>
                    <p id="supportProgressCount" class="text-2xl font-bold text-yellow-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm">Pending Student</p>
                    <p id="supportPendingCount" class="text-2xl font-bold text-blue-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm">Resolved</p>
                    <p id="supportResolvedCount" class="text-2xl font-bold text-green-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm">Avg Resolution</p>
                    <p id="supportAvgTime" class="text-2xl font-bold text-purple-600">--</p>
                </div>
            </div>

            <!-- Escalation Flow Diagram -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <h3 class="font-bold text-lg mb-3"><i class="fas fa-project-diagram mr-2 text-blue-600"></i>Escalation Flow</h3>
                <div class="flex items-center justify-center gap-2 text-sm overflow-x-auto py-2">
                    <div class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-user mr-1"></i>Student Query
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-robot mr-1"></i>AI Processing
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-question mr-1"></i>Confidence &lt; 70%?
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="bg-red-100 text-red-700 px-4 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-ticket-alt mr-1"></i>Create Ticket
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg whitespace-nowrap">
                        <i class="fas fa-headset mr-1"></i>Staff Support
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Tickets List -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-lg"><i class="fas fa-ticket-alt mr-2 text-green-600"></i>Support Tickets</h3>
                        <select id="ticketStatusFilter" onchange="loadTickets()" class="text-sm border rounded-lg px-3 py-1">
                            <option value="">All Tickets</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="pending_student">Pending Student</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="p-4 max-h-[500px] overflow-y-auto">
                        <div id="ticketsList" class="space-y-3">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Ticket Detail -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <h3 class="font-bold text-lg"><i class="fas fa-comments mr-2 text-blue-600"></i>Ticket Detail</h3>
                    </div>
                    <div id="ticketDetail" class="p-4">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-ticket-alt text-4xl mb-2"></i>
                            <p>Select a ticket to view details</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Why Escalation Matters -->
            <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-100">
                <h3 class="font-bold text-lg mb-3"><i class="fas fa-info-circle mr-2 text-blue-600"></i>Why AI + Human Support?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <p class="font-medium text-blue-700">ğŸ¤– AI Handles (70%+ Confidence)</p>
                        <ul class="mt-1 text-gray-600 space-y-1">
                            <li>â€¢ FAQ questions</li>
                            <li>â€¢ Status inquiries</li>
                            <li>â€¢ Simple information lookup</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-medium text-orange-700">âš ï¸ Escalated (&lt;70% Confidence)</p>
                        <ul class="mt-1 text-gray-600 space-y-1">
                            <li>â€¢ Complex appeals</li>
                            <li>â€¢ Special circumstances</li>
                            <li>â€¢ Policy exceptions</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-medium text-green-700">âœ… Benefits</p>
                        <ul class="mt-1 text-gray-600 space-y-1">
                            <li>â€¢ 73% queries auto-resolved</li>
                            <li>â€¢ Staff focus on complex issues</li>
                            <li>â€¢ Better student experience</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View (Staff/Admin Only) -->
        <div id="adminView" class="hidden max-w-6xl mx-auto p-4">
            <!-- Admin Header -->
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-2xl p-6 text-white mb-6 shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-shield-alt text-3xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Administration Panel</h2>
                        <p class="text-purple-100">System Management & Legacy Integration</p>
                    </div>
                </div>
            </div>

            <!-- Admin Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm">Total Users</p>
                    <p id="adminTotalUsers" class="text-2xl font-bold text-gray-800">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm">Students</p>
                    <p id="adminStudentCount" class="text-2xl font-bold text-blue-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm">Staff</p>
                    <p id="adminStaffCount" class="text-2xl font-bold text-green-600">--</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                    <p class="text-gray-500 text-sm">Admins</p>
                    <p id="adminAdminCount" class="text-2xl font-bold text-red-600">--</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Users Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <h3 class="font-bold text-lg"><i class="fas fa-users mr-2 text-purple-600"></i>User Management</h3>
                    </div>
                    <div class="p-4 max-h-96 overflow-y-auto">
                        <table class="w-full">
                            <thead class="text-left text-sm text-gray-500">
                                <tr>
                                    <th class="pb-2">User</th>
                                    <th class="pb-2">Role</th>
                                    <th class="pb-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersTable" class="text-sm">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- RBAC Matrix -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <h3 class="font-bold text-lg"><i class="fas fa-key mr-2 text-orange-600"></i>Role Permissions Matrix</h3>
                    </div>
                    <div class="p-4 max-h-96 overflow-y-auto">
                        <div id="rbacMatrix" class="space-y-4">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legacy Systems Status -->
            <div class="mt-6 bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <h3 class="font-bold text-lg"><i class="fas fa-server mr-2 text-blue-600"></i>Legacy Systems Integration (On-Premise)</h3>
                    <p class="text-sm text-gray-500 mt-1">Real-time status of enterprise systems connected via ESB</p>
                </div>
                <div class="p-4">
                    <div id="legacySystemsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Architecture Diagram -->
            <div class="mt-6 bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <h3 class="font-bold text-lg"><i class="fas fa-project-diagram mr-2 text-green-600"></i>System Architecture</h3>
                </div>
                <div class="p-6">
                    <pre class="text-xs bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLOUD INFRASTRUCTURE                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Frontend  â”‚  â”‚   FastAPI   â”‚  â”‚   AI/ML     â”‚  â”‚  Analytics  â”‚        â”‚
â”‚  â”‚   (React)   â”‚â”€â”€â”‚   Gateway   â”‚â”€â”€â”‚   Service   â”‚â”€â”€â”‚   (Cloud)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                                   â”‚
â”‚                          â–¼                                                   â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚               â”‚ ENTERPRISE SERVICE   â”‚                                      â”‚
â”‚               â”‚      BUS (ESB)       â”‚                                      â”‚
â”‚               â”‚   [MuleSoft/Azure]   â”‚                                      â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Secure VPN / ExpressRoute
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â–¼           ON-PREMISE DATACENTER                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Admissionsâ”‚  â”‚ Academic  â”‚  â”‚ Financial â”‚  â”‚  Housing  â”‚  â”‚ Directory â”‚ â”‚
â”‚  â”‚  (Banner) â”‚  â”‚(PeopleSoftâ”‚  â”‚(PowerFAIDSâ”‚  â”‚ (StarRez) â”‚  â”‚   (AD)    â”‚ â”‚
â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚ â”‚
â”‚  â”‚ FERPA âœ“   â”‚  â”‚ FERPA âœ“   â”‚  â”‚ PCI-DSS âœ“ â”‚  â”‚ Privacy âœ“ â”‚  â”‚ Security âœ“â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let token = null;
        let studentId = 'STU2024001';
        let currentUser = null;
        let studentProfileData = null;

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);
                
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    
                    // Get user info to determine role
                    await loadCurrentUser();
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    await initChat();
                    
                    // Load appropriate data based on role
                    if (currentUser.student_id) {
                        studentId = currentUser.student_id;
                        loadProfile();
                    }
                    
                    if (currentUser.is_staff || currentUser.is_admin) {
                        loadAnalytics();
                    }
                } else {
                    document.getElementById('loginError').textContent = 'Invalid credentials. Please try again.';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Connection error. Is the server running?';
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_URL}/api/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    
                    // Show role badge
                    document.getElementById('userBadge').classList.remove('hidden');
                    const roleText = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                    document.getElementById('userRole').textContent = roleText;
                    
                    // Show/hide tabs based on role
                    if (currentUser.ui_capabilities.can_view_admin_panel) {
                        document.getElementById('adminTab').classList.remove('hidden');
                        document.getElementById('supportTab').classList.remove('hidden');
                    }
                    
                    // Hide profile tab for non-students
                    if (!currentUser.student_id) {
                        document.getElementById('profileTab').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading current user:', error);
            }
        }

        // Initialize chat with welcome message
        async function initChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            addMessage('bot', `Hi! ğŸ‘‹ I'm UniAssist, your AI-powered student support assistant.\n\nI have access to your student profile and can help you with:\n\nâ€¢ ğŸ’° Financial Aid & Tuition\nâ€¢ ğŸ“š Course Registration\nâ€¢ ğŸ“Š Academic Records & Grades\nâ€¢ ğŸ  Housing Information\nâ€¢ ğŸ“ Admissions Questions\n\nI'll do my best to resolve your queries instantly. If I'm unable to help, I'll connect you with our support staff.\n\nHow can I help you today?`);
            
            // Check if student has existing tickets and update button
            if (currentUser?.student_id) {
                try {
                    const response = await fetch(`${API_URL}/api/tickets/my`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const ticketCount = data.tickets?.length || 0;
                        const btnText = document.getElementById('ticketsBtnText');
                        if (btnText) {
                            if (ticketCount > 0) {
                                btnText.textContent = `ğŸ“‹ My Tickets (${ticketCount})`;
                                btnText.parentElement.classList.add('bg-blue-100', 'px-2', 'py-1', 'rounded');
                            } else {
                                btnText.textContent = 'ğŸ“‹ My Tickets';
                            }
                        }
                    }
                } catch (e) { 
                    console.error('Error checking tickets:', e);
                }
            }
        }

        // Simple markdown to HTML converter
        function formatMessage(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\*(.+?)\*/g, '<em>$1</em>')              // Italic
                .replace(/_(.+?)_/g, '<em>$1</em>')                // Italic with underscore
                .replace(/---/g, '<hr class="my-2 border-gray-300">')  // Horizontal rule
                .replace(/\n/g, '<br>');                          // Line breaks
        }

        // Add message to chat
        function addMessage(type, text, metadata = {}) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-3 message-enter ${type === 'user' ? 'flex-row-reverse' : ''}`;
            
            const icon = type === 'user' ? 'fa-user' : 'fa-robot';
            const bgColor = type === 'user' ? 'bg-blue-600' : 'bg-green-600';
            const msgBg = type === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800';
            
            let metaHtml = '';
            if (metadata.category) {
                const confidencePercent = Math.round((metadata.confidence || 0) * 100);
                const showEscalate = confidencePercent < 85; // Show escalate option for lower confidence
                metaHtml = `<div class="text-xs text-gray-400 mt-1">
                    <span class="bg-gray-200 px-2 py-0.5 rounded">${metadata.category}</span>
                    ${metadata.confidence ? `<span class="ml-2">${confidencePercent}% confident</span>` : ''}
                    ${showEscalate ? `<button onclick="raiseTicketFromChat()" class="ml-2 text-blue-600 hover:text-blue-800 underline">
                        <i class="fas fa-headset"></i> Talk to Support
                    </button>` : ''}
                </div>`;
                
                // Store last query for potential escalation
                window.lastQuery = { text: text, category: metadata.category, confidence: metadata.confidence };
            }
            
            const formattedText = formatMessage(text);
            
            msgDiv.innerHTML = `
                <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas ${icon} text-white text-sm"></i>
                </div>
                <div class="max-w-[80%]">
                    <div class="${msgBg} rounded-2xl px-4 py-3">
                        <div class="text-sm">${formattedText}</div>
                    </div>
                    ${metaHtml}
                </div>
            `;
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Raise ticket from chat
        async function raiseTicketFromChat() {
            const lastUserMsg = document.querySelectorAll('#chatMessages > div');
            let userQuery = '';
            
            // Find the last user message
            for (let i = lastUserMsg.length - 1; i >= 0; i--) {
                if (lastUserMsg[i].classList.contains('flex-row-reverse')) {
                    // Get text from the message div (handles both p and div.text-sm)
                    userQuery = lastUserMsg[i].querySelector('.text-sm')?.textContent || 
                                lastUserMsg[i].querySelector('p')?.textContent || '';
                    break;
                }
            }
            
            // If no user message found, use stored lastUserMessage or lastQuery
            if (!userQuery) {
                userQuery = window.lastUserMessage || window.lastQuery?.text || '';
            }
            
            if (!userQuery) {
                addMessage('bot', 'Please ask a question first, then I can connect you with support.');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/tickets/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        query: userQuery,
                        category: window.lastQuery?.category || 'general',
                        ai_confidence: window.lastQuery?.confidence || 0.5
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage('bot', `âœ… I've created a support ticket for you!\n\nğŸ“‹ Ticket ID: ${data.ticket.id}\n\nA support staff member will review your query and respond soon. You can view your tickets by clicking "My Tickets" above.\n\nTypical response time: 4-24 hours`, {});
                    
                    // Update ticket count in button
                    const btnText = document.getElementById('ticketsBtnText');
                    if (btnText) {
                        const currentText = btnText.textContent;
                        const match = currentText.match(/\((\d+)\)/);
                        const count = match ? parseInt(match[1]) + 1 : 1;
                        btnText.textContent = `ğŸ“‹ My Tickets (${count})`;
                        btnText.parentElement.classList.add('bg-blue-100', 'px-2', 'py-1', 'rounded');
                    }
                } else {
                    addMessage('bot', 'Sorry, I could not create a ticket. Please try again.');
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                addMessage('bot', 'Connection error. Please try again.');
            }
        }

        // Show my tickets modal for students
        async function showMyTickets() {
            try {
                const response = await fetch(`${API_URL}/api/tickets/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.tickets && data.tickets.length > 0) {
                        // Show ticket list first
                        let ticketsList = data.tickets.map(t => {
                            const statusEmoji = {
                                'open': 'ğŸ”´',
                                'in_progress': 'ğŸŸ¡',
                                'pending_student': 'ğŸ”µ',
                                'resolved': 'ğŸŸ¢',
                                'closed': 'âš«'
                            };
                            return `${statusEmoji[t.status] || 'âšª'} **${t.id}** - ${t.status.replace('_', ' ')}\n   ${t.original_query.substring(0, 50)}...`;
                        }).join('\n\n');
                        
                        addMessage('bot', `ğŸ“‹ **Your Support Tickets:**\n\n${ticketsList}\n\n_Status: ğŸ”´ Open | ğŸŸ¡ In Progress | ğŸ”µ Awaiting Your Reply | ğŸŸ¢ Resolved_\n\nğŸ‘‡ See conversation threads below:`);
                        
                        // Show each ticket with its full conversation thread
                        for (const ticket of data.tickets) {
                            let conversationThread = '';
                            
                            if (ticket.messages && ticket.messages.length > 0) {
                                conversationThread = ticket.messages.map(msg => {
                                    const senderIcon = msg.sender === 'student' ? 'ğŸ‘¤ You' : 
                                                      msg.sender === 'staff' ? `ğŸ‘” ${msg.sender_name || 'Support Staff'}` : 
                                                      'ğŸ¤– System';
                                    const time = new Date(msg.timestamp).toLocaleString();
                                    return `**${senderIcon}** _(${time})_\n${msg.message}`;
                                }).join('\n\n---\n\n');
                            } else {
                                conversationThread = '_No messages yet_';
                            }
                            
                            const statusEmoji = {
                                'open': 'ğŸ”´ Open',
                                'in_progress': 'ğŸŸ¡ In Progress',
                                'pending_student': 'ğŸ”µ Awaiting Your Reply',
                                'resolved': 'ğŸŸ¢ Resolved',
                                'closed': 'âš« Closed'
                            };
                            
                            addMessage('bot', `ğŸ« **Ticket: ${ticket.id}**\nğŸ“Œ Status: ${statusEmoji[ticket.status] || ticket.status}\nğŸ“ Category: ${ticket.category}\n\n**Conversation:**\n\n${conversationThread}${ticket.status === 'pending_student' ? '\n\nâš ï¸ _Staff is waiting for your reply!_' : ''}`);
                        }
                    } else {
                        addMessage('bot', "You don't have any support tickets yet. If I can't resolve your query, I'll automatically offer to connect you with our support staff.");
                    }
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                addMessage('bot', 'Could not load your tickets. Please try again.');
            }
        }

        // Show typing indicator
        function showTyping() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex gap-3 message-enter';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-gray-100 rounded-2xl px-4 py-3">
                    <div class="typing-indicator text-gray-500">
                        <span>â—</span><span>â—</span><span>â—</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // Send chat message
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Store the user's message for potential ticket creation
            window.lastUserMessage = message;
            
            input.value = '';
            addMessage('user', message);
            showTyping();
            
            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        message: message
                    })
                });
                
                hideTyping();
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage('bot', data.text, {
                        category: data.category,
                        confidence: data.confidence
                    });
                } else {
                    addMessage('bot', 'Sorry, I encountered an error. Please try again.');
                }
            } catch (error) {
                hideTyping();
                addMessage('bot', 'Connection error. Please check if the server is running.');
            }
        });

        // Quick question
        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }

        // Load profile
        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/api/students/${studentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('profileName').textContent = data.name;
                    document.getElementById('profileProgram').textContent = data.program;
                    document.getElementById('profileId').textContent = data.id;
                    document.getElementById('profileYear').textContent = `Year ${data.year}`;
                    document.getElementById('profileGpa').textContent = data.gpa;
                    document.getElementById('profileBuilding').textContent = data.housing.building;
                    document.getElementById('profileRoom').textContent = data.housing.room;
                    document.getElementById('profileAidStatus').textContent = data.financial_aid.status;
                    document.getElementById('profileAidAmount').textContent = `$${data.financial_aid.amount.toLocaleString()}`;
                    document.getElementById('profileAidDate').textContent = data.financial_aid.disbursement_date;
                    
                    const coursesDiv = document.getElementById('profileCourses');
                    coursesDiv.innerHTML = data.courses.map(c => 
                        `<p><span class="font-medium">${c.code}</span> - ${c.name} <span class="text-green-600">(${c.grade})</span></p>`
                    ).join('');

                    studentProfileData = data;
                    populateStudentAnalytics();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function populateStudentAnalytics() {
            if (!studentProfileData) return;

            const {
                name = 'Student',
                program = '--',
                year = '--',
                gpa = '--',
                courses = [],
                financial_aid: financialAid = {}
            } = studentProfileData;

            const formatDate = (value) => {
                if (!value) return 'TBD';
                const parsed = new Date(value);
                return Number.isNaN(parsed.getTime())
                    ? value
                    : parsed.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };

            const firstName = (name && name.split(' ')[0]) || 'Student';
            const courseCount = courses.length;
            const activeCourses = courses.filter(course => (course.status || '').toLowerCase() !== 'completed');
            const topCourse = activeCourses[0] || courses[0];
            const secondCourse = activeCourses[1] || courses[1];
            const disbursementRaw = financialAid?.disbursement_date;
            const disbursementFormatted = formatDate(disbursementRaw);

            const supportMetrics = {
                questions: courseCount ? 6 + courseCount : 4,
                instantRate: '82% instant answers',
                response: '2m 18s average',
                satisfaction: '4.7 / 5 confidence'
            };

            const timelineItems = [
                disbursementRaw && {
                    date: disbursementFormatted,
                    title: 'Financial Aid Disbursement',
                    description: `Funds release on ${financialAid.disbursement_date}. Confirm your banking details two days prior.`
                },
                topCourse && {
                    date: 'Next Week',
                    title: `${topCourse.code} â€” Project milestone`,
                    description: 'Draft outline due. Block 45 minutes for focused research and upload to the course portal.'
                },
                {
                    date: 'Month-End',
                    title: 'Advisor Check-in',
                    description: 'Schedule a 15-minute sync with your academic advisor to review progress and summer planning.'
                }
            ].filter(Boolean);

            const tips = [
                {
                    label: 'Stay ahead',
                    text: 'Set a 30-minute review block after each class. Short daily refresh keeps your cumulative GPA trending upward.'
                },
                financialAid?.status && {
                    label: 'Financial aid',
                    text: `Confirm your aid status (â€œ${financialAid.status}â€) and upload any pending documents before ${disbursementFormatted}.`
                },
                secondCourse && {
                    label: secondCourse.code,
                    text: `Pair up with a classmate for a weekly study sync. Collaborative prep boosts retention for ${secondCourse.name}.`
                }
            ].filter(Boolean);

            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value;
                }
            };

            setText('analyticsStudentName', firstName);
            setText('analyticsGpa', typeof gpa === 'number' ? gpa.toFixed(2) : gpa);
            setText('analyticsProgram', `Program â€¢ ${program}`);
            setText('analyticsYear', `Year ${year}`);
            setText('analyticsCourseCount', `${courseCount} course${courseCount === 1 ? '' : 's'}`);
            setText('analyticsAidStatus', financialAid?.status ? `${financialAid.status} â€¢ Next: ${disbursementFormatted}` : 'Aid status unavailable');
            setText('analyticsQuestions', supportMetrics.questions);
            setText('analyticsInstantRate', supportMetrics.instantRate);
            setText('analyticsResponse', supportMetrics.response);
            setText('analyticsSatisfaction', supportMetrics.satisfaction);

            const courseList = document.getElementById('analyticsCourseList');
            if (courseList) {
                courseList.innerHTML = courses.length
                    ? courses.map(course => `
                        <li class="course-item">
                            <div>
                                <p class="title">${course.code}</p>
                                <p class="subtitle">${course.name}</p>
                            </div>
                            <span class="badge text-xs">${course.grade || (course.status || 'In Progress')}</span>
                        </li>
                    `).join('')
                    : '<li class="tip-card">No active courses are currently linked to your profile.</li>';
            }

            const timelineList = document.getElementById('analyticsTimeline');
            if (timelineList) {
                timelineList.innerHTML = timelineItems.length
                    ? timelineItems.map(item => `
                        <li class="timeline-item">
                            <span class="timeline-marker"></span>
                            <div class="timeline-content">
                                <p class="date">${item.date}</p>
                                <p class="title">${item.title}</p>
                                <p class="description">${item.description}</p>
                            </div>
                        </li>
                    `).join('')
                    : '<li class="tip-card">No upcoming reminders at the moment.</li>';
            }

            const tipsList = document.getElementById('analyticsTips');
            if (tipsList) {
                tipsList.innerHTML = tips.length
                    ? tips.map(tip => `
                        <li class="tip-card">
                            <strong>${tip.label}</strong>
                            <p class="mt-1 text-secondary text-sm leading-relaxed">${tip.text}</p>
                        </li>
                    `).join('')
                    : '<li class="tip-card">Weâ€™ll add new suggestions once more activity is available.</li>';
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_URL}/api/analytics`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalQueries').textContent = data.total_queries.toLocaleString();
                    document.getElementById('automatedRate').textContent = `${data.automated_resolution}%`;
                    document.getElementById('avgResponse').textContent = `${data.avg_response_time}s`;
                    document.getElementById('satisfaction').textContent = `${data.satisfaction_score}%`;
                    
                    // Categories chart
                    const categoriesDiv = document.getElementById('categoriesChart');
                    categoriesDiv.innerHTML = data.top_categories.map(cat => `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>${cat.name}</span>
                                <span class="text-gray-500">${cat.count} (${cat.percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${cat.percentage}%"></div>
                            </div>
                        </div>
                    `).join('');
                    
                    // ROI metrics
                    const roiDiv = document.getElementById('roiMetrics');
                    const roi = data.roi_metrics;
                    roiDiv.innerHTML = `
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Cost per Query (Human)</span>
                            <span class="font-bold">${roi.cost_per_query_human}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Cost per Query (AI)</span>
                            <span class="font-bold text-green-600">${roi.cost_per_query_ai}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Workload Reduction</span>
                            <span class="font-bold">${roi.workload_reduction_percent}%</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Monthly Savings</span>
                            <span class="font-bold text-green-600">${roi.monthly_savings_projected}</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">Year 1 ROI</span>
                            <span class="font-bold text-blue-600">${roi.roi_year1_percent}%</span>
                        </div>
                    `;
                }
                
                // Load ESB status
                const esbResponse = await fetch(`${API_URL}/api/esb/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (esbResponse.ok) {
                    const esbData = await esbResponse.json();
                    const esbDiv = document.getElementById('esbStatus');
                    esbDiv.innerHTML = esbData.connected_systems.map(sys => `
                        <div class="p-3 rounded-lg border ${sys.status === 'operational' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-2 h-2 rounded-full ${sys.status === 'operational' ? 'bg-green-500' : 'bg-red-500'}"></span>
                                <span class="font-medium text-sm">${sys.name.split(' ')[0]}</span>
                            </div>
                            <p class="text-xs text-gray-500">${sys.vendor}</p>
                            <p class="text-xs text-gray-400">${sys.location}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Tab navigation
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('bg-white/20'));
            document.getElementById(`${tab}Tab`).classList.add('bg-white/20');
            
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('analyticsView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('supportView').classList.add('hidden');
            document.getElementById(`${tab}View`).classList.remove('hidden');
            
            if (tab === 'analytics') loadAnalytics();
            if (tab === 'admin') loadAdminPanel();
            if (tab === 'support') loadSupportPortal();
        }

        // Load Support Staff Portal
        async function loadSupportPortal() {
            await loadTickets();
        }

        // Load tickets
        let selectedTicketId = null;
        
        async function loadTickets() {
            try {
                const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';
                const url = statusFilter ? `${API_URL}/api/tickets?status=${statusFilter}` : `${API_URL}/api/tickets`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update stats
                    if (data.stats) {
                        document.getElementById('supportOpenCount').textContent = data.stats.open || 0;
                        document.getElementById('supportProgressCount').textContent = data.stats.in_progress || 0;
                        document.getElementById('supportPendingCount').textContent = data.stats.pending_student || 0;
                        document.getElementById('supportResolvedCount').textContent = data.stats.resolved || 0;
                        document.getElementById('supportAvgTime').textContent = data.stats.avg_resolution_time || '--';
                    }
                    
                    // Render tickets list
                    const ticketsList = document.getElementById('ticketsList');
                    if (data.tickets && data.tickets.length > 0) {
                        ticketsList.innerHTML = data.tickets.map(ticket => {
                            const statusColors = {
                                'open': 'bg-red-100 text-red-700 border-red-200',
                                'in_progress': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                                'pending_student': 'bg-blue-100 text-blue-700 border-blue-200',
                                'resolved': 'bg-green-100 text-green-700 border-green-200',
                                'closed': 'bg-gray-100 text-gray-700 border-gray-200'
                            };
                            const priorityColors = {
                                'low': 'text-gray-500',
                                'medium': 'text-yellow-500',
                                'high': 'text-orange-500',
                                'urgent': 'text-red-500'
                            };
                            return `
                                <div onclick="selectTicket('${ticket.id}')" 
                                     class="p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${selectedTicketId === ticket.id ? 'ring-2 ring-blue-500' : ''}">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-sm">${ticket.id}</span>
                                        <span class="px-2 py-1 rounded-full text-xs ${statusColors[ticket.status]}">${ticket.status.replace('_', ' ')}</span>
                                    </div>
                                    <p class="font-medium">${ticket.student_name}</p>
                                    <p class="text-sm text-gray-500 truncate">${ticket.original_query}</p>
                                    <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                                        <span><i class="fas fa-tag mr-1"></i>${ticket.category}</span>
                                        <span class="${priorityColors[ticket.priority]}"><i class="fas fa-exclamation-circle mr-1"></i>${ticket.priority}</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        <span>Confidence: ${Math.round((ticket.ai_confidence || 0) * 100)}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        ticketsList.innerHTML = '<p class="text-center text-gray-400 py-8">No tickets found</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
            }
        }

        // Select ticket
        async function selectTicket(ticketId) {
            selectedTicketId = ticketId;
            
            try {
                const response = await fetch(`${API_URL}/api/tickets/${ticketId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const ticket = await response.json();
                    renderTicketDetail(ticket);
                    loadTickets(); // Refresh list to show selection
                }
            } catch (error) {
                console.error('Error loading ticket detail:', error);
            }
        }

        // Render ticket detail
        function renderTicketDetail(ticket) {
            const detailDiv = document.getElementById('ticketDetail');
            
            const statusColors = {
                'open': 'bg-red-100 text-red-700',
                'in_progress': 'bg-yellow-100 text-yellow-700',
                'pending_student': 'bg-blue-100 text-blue-700',
                'resolved': 'bg-green-100 text-green-700'
            };
            
            detailDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${ticket.student_name}</h4>
                            <p class="text-sm text-gray-500">${ticket.student_email}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs ${statusColors[ticket.status]}">${ticket.status.replace('_', ' ')}</span>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 text-sm">
                        <p class="font-medium text-gray-700 mb-1">Original Query:</p>
                        <p class="text-gray-600">${ticket.original_query}</p>
                        <p class="text-xs text-gray-400 mt-2">AI Confidence: ${Math.round((ticket.ai_confidence || 0) * 100)}%</p>
                    </div>
                    
                    <div class="border-t pt-3">
                        <p class="font-medium text-sm mb-2">Conversation:</p>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${ticket.messages.map(msg => `
                                <div class="text-sm ${msg.sender === 'student' ? 'bg-blue-50 ml-4' : msg.sender === 'staff' ? 'bg-green-50 mr-4' : 'bg-gray-100'} rounded-lg p-2">
                                    <p class="text-xs text-gray-500 mb-1">
                                        ${msg.sender === 'student' ? 'ğŸ‘¨â€ğŸ“ Student' : msg.sender === 'staff' ? 'ğŸ‘” ' + (msg.sender_name || 'Staff') : 'ğŸ¤– System'}
                                    </p>
                                    <p>${msg.message}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${ticket.status !== 'resolved' && ticket.status !== 'closed' ? `
                        <div class="border-t pt-3 space-y-2">
                            ${!ticket.assigned_to ? `
                                <button onclick="assignTicket('${ticket.id}')" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm hover:bg-blue-700">
                                    <i class="fas fa-hand-paper mr-2"></i>Claim This Ticket
                                </button>
                            ` : ''}
                            <div class="flex gap-2">
                                <input type="text" id="replyInput" placeholder="Type your reply..." 
                                    class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                <button onclick="sendReply('${ticket.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <button onclick="resolveTicket('${ticket.id}')" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-sm hover:bg-gray-200">
                                <i class="fas fa-check mr-2"></i>Mark as Resolved
                            </button>
                        </div>
                    ` : `
                        <div class="bg-green-50 p-3 rounded-lg text-sm">
                            <p class="font-medium text-green-700"><i class="fas fa-check-circle mr-2"></i>Resolved</p>
                            ${ticket.resolution_notes ? `<p class="text-gray-600 mt-1">${ticket.resolution_notes}</p>` : ''}
                        </div>
                    `}
                </div>
            `;
        }

        // Assign ticket
        async function assignTicket(ticketId) {
            try {
                const response = await fetch(`${API_URL}/api/tickets/${ticketId}/assign`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    selectTicket(ticketId);
                    loadTickets();
                }
            } catch (error) {
                console.error('Error assigning ticket:', error);
            }
        }

        // Send reply
        async function sendReply(ticketId) {
            const input = document.getElementById('replyInput');
            const message = input.value.trim();
            if (!message) return;
            
            try {
                const response = await fetch(`${API_URL}/api/tickets/${ticketId}/message`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: message })
                });
                
                if (response.ok) {
                    input.value = '';
                    selectTicket(ticketId);
                }
            } catch (error) {
                console.error('Error sending reply:', error);
            }
        }

        // Resolve ticket
        async function resolveTicket(ticketId) {
            const notes = prompt('Enter resolution notes:');
            if (!notes) return;
            
            try {
                const response = await fetch(`${API_URL}/api/tickets/${ticketId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes })
                });
                
                if (response.ok) {
                    selectTicket(ticketId);
                    loadTickets();
                }
            } catch (error) {
                console.error('Error resolving ticket:', error);
            }
        }

        // Load Admin Panel
        async function loadAdminPanel() {
            try {
                // Load users
                const usersResponse = await fetch(`${API_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    
                    document.getElementById('adminTotalUsers').textContent = usersData.total_users;
                    document.getElementById('adminStudentCount').textContent = usersData.role_summary.students;
                    document.getElementById('adminStaffCount').textContent = usersData.role_summary.staff;
                    document.getElementById('adminAdminCount').textContent = usersData.role_summary.admins;
                    
                    // Populate users table
                    const tableBody = document.getElementById('adminUsersTable');
                    tableBody.innerHTML = usersData.users.map(user => {
                        const roleColors = {
                            'student': 'bg-blue-100 text-blue-700',
                            'staff': 'bg-green-100 text-green-700',
                            'admin': 'bg-red-100 text-red-700'
                        };
                        return `
                            <tr class="border-b">
                                <td class="py-2">
                                    <div class="font-medium">${user.name}</div>
                                    <div class="text-xs text-gray-400">${user.username}</div>
                                </td>
                                <td class="py-2">
                                    <span class="px-2 py-1 rounded-full text-xs ${roleColors[user.role]}">${user.role}</span>
                                </td>
                                <td class="py-2">
                                    <span class="w-2 h-2 inline-block rounded-full ${user.is_active ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                // Load RBAC info
                const rbacResponse = await fetch(`${API_URL}/api/admin/roles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (rbacResponse.ok) {
                    const rbacData = await rbacResponse.json();
                    const rbacDiv = document.getElementById('rbacMatrix');
                    
                    rbacDiv.innerHTML = Object.entries(rbacData.role_permissions).map(([role, permissions]) => {
                        const roleColors = {
                            'student': 'border-blue-500 bg-blue-50',
                            'staff': 'border-green-500 bg-green-50',
                            'admin': 'border-red-500 bg-red-50'
                        };
                        return `
                            <div class="p-3 rounded-lg border-l-4 ${roleColors[role]}">
                                <div class="font-bold capitalize mb-2">${role}</div>
                                <div class="flex flex-wrap gap-1">
                                    ${permissions.map(p => `<span class="text-xs bg-white px-2 py-1 rounded">${p.replace(/_/g, ' ')}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Load Legacy Systems
                const legacyResponse = await fetch(`${API_URL}/api/admin/legacy-systems`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (legacyResponse.ok) {
                    const legacyData = await legacyResponse.json();
                    const legacyDiv = document.getElementById('legacySystemsGrid');
                    
                    legacyDiv.innerHTML = legacyData.systems.map(sys => {
                        const statusColor = sys.status === 'operational' ? 'border-green-500' : 'border-red-500';
                        const statusBg = sys.status === 'operational' ? 'bg-green-100' : 'bg-red-100';
                        const statusDot = sys.status === 'operational' ? 'bg-green-500' : 'bg-red-500';
                        
                        return `
                            <div class="p-4 rounded-xl border-2 ${statusColor} ${statusBg}">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-bold">${sys.name}</span>
                                    <span class="w-3 h-3 rounded-full ${statusDot}"></span>
                                </div>
                                <p class="text-sm text-gray-600">${sys.vendor}</p>
                                <div class="mt-2 flex items-center gap-2 text-xs">
                                    <span class="px-2 py-1 bg-white rounded">${sys.location}</span>
                                    ${sys.compliance ? sys.compliance.map(c => `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">${c}</span>`).join('') : ''}
                                </div>
                                <p class="text-xs text-gray-400 mt-2">${sys.description || ''}</p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading admin panel:', error);
            }
        }

        // Logout
        function logout() {
            token = null;
            currentUser = null;
            selectedTicketId = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            document.getElementById('supportTab').classList.add('hidden');
            document.getElementById('profileTab').classList.remove('hidden');
            document.getElementById('userBadge').classList.add('hidden');
        }
    </script>
</body>
</html>
